{% extends "base.html" %}

{% block title %}Your Account{% endblock %}

{% block content %}

<style>
    .info-button {
        width: 19px; /* Set the width and height to control the button size */
        height: 19px;
        border-radius: 50%; /* Make the button round */
        background-color: #7cb1cc; /* Add background color */
        color: white; /* Set text color */
        border: none; /* Remove the border */
        cursor: pointer; /* Add a pointer cursor on hover */
    }

     .logout-link {
        position: absolute;
        top: 50px; /* Adjust the top position as needed */
        right: 20px;
    }

    /* Add styles for the "Back to Flight Search" button */
    .back-button {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    /* Add space between tickets */
    .flight-history td {
        padding: 5px; /* Adjust the padding to increase space */
    }
</style>

	<div class="container">
        <a href="/flight-search" class="back-button">
        <button class="btn btn-primary">
            <i class="fas fa-plane-departure"></i> Back to Flight Search
        </button>
        </a>
        <a href="/logout" class="logout-link">Logout</a>
        <h1>Your Account</h1>
        <br>

		<div class="personal-info">
			<p style="font-weight: bold; font-size: 18px;">Personal Data</p>
            {% for client in client_data %}
            <p><strong>Name:</strong> {{ client.user_name }}</p>
            <p><strong>Email:</strong> {{ client.user_email }}</p>
            <p><strong>Tier: </strong>{{ client.tier }}
                <button class="info-button" onclick="toggleInfo('info{{ loop.index }}')">i</button>
            </p>
                <div class="tier-info" id="info{{ loop.index }}" style="display: none;">
                    ---------------------------------------------------------------------------------------------------------<br>
                    You earn 1 mile for every mile flown. Different tiers come with different benefits.
                    <br>
                    Bronze Tier: You start as a Bronze member
                    <br>
                    Silver Tier: With 1.000 flown miles, you reach the Silver tier
                    <br>
                    Gold Tier: You achieve Gold status with 10.000 flown miles.
                    <br>
                    ---------------------------------------------------------------------------------------------------------<br>
                </div>
			<p><strong> Total miles:</strong> {{client.miles }}</p>
            {% endfor %}
		</div>

        <br>
		<div class="flight-history">
			<p style="font-weight: bold; font-size: 18px;">Flight History</p>
			<table style="table-layout: auto; width: 100%;">
                <tr>
                    <th style="width: auto;">Passenger</th>
                    <th style="width: auto;">Date</th>
                    <th style="width: auto;">Departure</th>
                    <th style="width: auto;">Destination</th>
                    <th style="width: auto;">Departure Time (UTC)</th>
                    <th style="width: auto;">Arrival Time (UTC)</th>
                    <th style="width: auto;">Class</th>
                    <th style="width: auto;">Miles</th>
                    <th style="width: auto;">Stornieren</th>
                    <th style="width: auto;">Check-In</th>
                </tr>

                {% for flight in flight_history %}
                <tr>
                    <td>{{ flight.ticket_name }}</td>
                    <td>{{ flight.ticket_date }}</td>
                    <td>{{ flight.flight_source }}</td>
                    <td>{{ flight.flight_destination }}</td>
                    <td>{{ flight.flight_depTime }}</td>
                    <td>{{ flight.flight_arrTime }}</td>
                    <td>{{ flight.ticket_class }}</td>
                    <td>{{ flight.ticket_miles }}</td>

                    <td>
                        {% if flight.ticketId not in cancellation_requests %}
                        <button
                            class="cancellation-button"
                            data-ticket-id="{{ flight.ticketId }}"
                            onclick="stornierenButtonClick(this)"
                            style="width: 100px;"
                            {% if flight.ticketId in check_in_status and check_in_status[flight.ticketId] %}disabled{% endif %}>
                            {% if flight.ticketId not in cancellation_requests %}
                            Stornieren
                            {% else %}
                            Pending
                            {% endif %}
                        </button>
                        {% else %}
                        <button class="cancellation-button" style="width: 100px; background-color: yellow;">
                            Pending
                        </button>
                        {% endif %}
                    </td>
                    <td>
                        <button
                            data-check-in-id="{{ flight.ticketId }}"
                            class="checkInButton"
                            onclick="checkInButtonClick(this, {{ flight.ticketId }})"
                            style="width: 100px;"
                            {% if flight.ticketId in cancellation_requests or flight.ticketId in check_in_status and check_in_status[flight.ticketId] %}disabled{% endif %}>
                            {% if flight.ticketId in check_in_status and check_in_status[flight.ticketId] %}
                            Checked In
                            {% else %}
                            Check-In
                            {% endif %}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </table>




		<br>


	</div>
	<br><br>


	<script>

    const check_in_status = {}; // Use this object to keep track of check-in status.

function checkInButtonClick(button, ticketId) {
        if (button.disabled) {
            // If the "Stornieren" button was already clicked, do nothing.
            return;
        }

        // Change the text and color of the "Check-In" button.
        button.innerHTML = "Checked In";
        button.style.backgroundColor = "green";
        button.disabled = true; // Disable the button to prevent further clicks.

        // Update the check-in status in the object.
        check_in_status[ticketId] = true;

        // Disable the corresponding "Stornieren" button.
        const stornierenButton = document.querySelector(`.cancellation-button[data-ticket-id="${ticketId}"]`);
        if (stornierenButton) {
            stornierenButton.disabled = true;
        }
    }

function stornierenButtonClick(button) {
        const ticketId = button.getAttribute("data-ticket-id");

        // Check if the "Check-In" button was already clicked.
        if (check_in_status[ticketId]) {
            // If the "Check-In" button was already clicked, do nothing.
            return;
        }

        // Disable the corresponding "CheckIn" button.
        const checkIn = document.querySelector(`.checkInButton[data-check-in-id="${ticketId}"]`);
        if (checkIn) {
            checkIn.disabled = true;
        }

        // Check if the button is already in "Pending" state.
        if (button.innerHTML.trim() === "Pending") {
            // If yes, change it back to "Stornieren" and remove the background color.
            button.innerHTML = "Stornieren";
            button.style.backgroundColor = "";
        } else {
            // Otherwise, set the button to "Pending" and change the background color to yellow.
            button.innerHTML = "Pending";
            button.style.backgroundColor = "yellow";
        }

        // Erstellen Sie ein JSON-Objekt mit der Ticket-ID.
        const data = {
            ticket_id: ticketId
        };

        // Senden Sie das JSON-Objekt an die Serverroute zum Stornieren.
        fetch("/cancel-ticket", {
            method: "POST",
            headers: {
                "Content-Type": "application/json", // Ã„ndern Sie den Content-Type auf JSON.
            },
            body: JSON.stringify(data), // Wandeln Sie das JSON-Objekt in einen String um.
        })
        .then((response) => {
            if (response.ok) {
                showNotification("Ticket cancellation request submitted successfully.", "success");
            } else {
                showNotification("Failed to submit ticket cancellation request.", "error");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
        });


    }

	</script>
    </div>
{% endblock %}